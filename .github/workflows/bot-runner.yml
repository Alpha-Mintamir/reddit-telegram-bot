name: Telegram Reddit Bot Runner

on:
  schedule:
    # Run every 5 minutes -- GitHub may delay, but the bot runs as a
    # mini-daemon for up to 4 minutes each time, so coverage is good.
    - cron: "*/5 * * * *"
  workflow_dispatch:
    inputs:
      mode:
        description: "Bot mode to run"
        required: true
        default: "once"
        type: choice
        options:
          - once
          - collect-ids
          - timed-daemon
      dry_run:
        description: "Run without sending or writing"
        required: true
        default: false
        type: boolean

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    concurrency:
      group: telegram-reddit-bot-runner
      cancel-in-progress: false
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      GOOGLE_SHEETS_SPREADSHEET_ID: ${{ secrets.GOOGLE_SHEETS_SPREADSHEET_ID }}
      GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
      REDDIT_USER_AGENT: ${{ secrets.REDDIT_USER_AGENT }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      BOT_REPLY_MODEL: ${{ secrets.BOT_REPLY_MODEL }}
      BOT_TIMEZONE: ${{ secrets.BOT_TIMEZONE }}
      BOT_DAILY_HOUR: ${{ secrets.BOT_DAILY_HOUR }}
      BOT_DAILY_MINUTE: ${{ secrets.BOT_DAILY_MINUTE }}
      BOT_POLL_INTERVAL_MINUTES: ${{ secrets.BOT_POLL_INTERVAL_MINUTES }}
      BOT_TEAMS_TAB: ${{ secrets.BOT_TEAMS_TAB }}
      BOT_POSTING_TAB: ${{ secrets.BOT_POSTING_TAB }}
      BOT_REPLY_QUEUE_TAB: ${{ secrets.BOT_REPLY_QUEUE_TAB }}
      BOT_STATE_TAB: ${{ secrets.BOT_STATE_TAB }}
      BOT_METRICS_TAB: ${{ secrets.BOT_METRICS_TAB }}
      BOT_TEST_POSTS_TAB: ${{ secrets.BOT_TEST_POSTS_TAB }}
      BOT_REPLY_TIMEOUT_HOURS: ${{ secrets.BOT_REPLY_TIMEOUT_HOURS }}
      BOT_MAX_REASSIGN: ${{ secrets.BOT_MAX_REASSIGN }}
      BOT_ALPHA_USERNAME: ${{ secrets.BOT_ALPHA_USERNAME }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Determine mode and dry-run flag
        id: vars
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "mode=${{ github.event.inputs.mode }}" >> $GITHUB_OUTPUT
            if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
              echo "dry_flag=--dry-run" >> $GITHUB_OUTPUT
            else
              echo "dry_flag=" >> $GITHUB_OUTPUT
            fi
          else
            # Scheduled runs use timed-daemon: runs multiple cycles
            # within a single job for faster response times
            echo "mode=timed-daemon" >> $GITHUB_OUTPUT
            echo "dry_flag=" >> $GITHUB_OUTPUT
          fi

      - name: Run bot
        run: python run_bot.py --mode ${{ steps.vars.outputs.mode }} ${{ steps.vars.outputs.dry_flag }}
